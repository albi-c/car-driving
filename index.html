<!DOCTYPE html>
<html>
	<head>
		<title>Palma Car Driving</title>
		<script src="canvas.js" type="text/javascript"></script>
	</head>
	<body>
		<canvas id="cvs" width="720px" height="480px" style="width: 720px; height: 480px; border: solid black 2px;">
			<h1>Your browser does not support the &lt;canvas&gt; HTML tag!</h1>
		</canvas>
		<script>
		let ctx = new GameCanvas2D("cvs");
		let cvs = ctx.cvs;
		let width = 720;
		let height = 480;
		
		ctx.ctx.webkitImageSmoothingEnabled = false;
		ctx.ctx.mozImageSmoothingEnabled = false;
		ctx.ctx.imageSmoothingEnabled = false;
		
		let storage = window.localStorage;
		if (!storage) {
			alert("DATA CANNOT BE SAVED!");
		}
		
		function save() {
			if (storage) {
				storage.player = JSON.stringify(player);
				storage.trees = JSON.stringify(trees);
				storage.grass = JSON.stringify([grass1, grass2]);
				storage.coins = JSON.stringify(coins);
			}
		}
		
		function load() {
			if (storage) {
				if (storage.player) {
					player = JSON.parse(storage.player);
				}
				if (storage.trees) {
					trees = JSON.parse(storage.trees);
				}
				if (storage.grass) {
					let _grass = JSON.parse(storage.grass);
					grass1 = _grass[0];
					grass2 = _grass[1];
				}
				if (storage.coins) {
					coins = JSON.parse(storage.coins);
				}
			}
		}
		
		function randint(mi, ma) {
			mi = Math.ceil(mi);
			ma = Math.floor(ma);
			return Math.floor(Math.random() * (ma - mi + 1)) + mi;
		}
		
		let player = {
			x: width / 2 - 32,
			y: height - 100,
			w: 64,
			h: 64,
			score: 0,
			keys: {left: false, right: false},
			speed: {side: 1.3, forward: 2},
			color: "yellow"
		};
		playerImg = new Image();
		playerImg.src = "res/car_" + player.color + ".png";
		
		function reloadCarColor() {
			playerImg.src = "res/car_" + player.color + ".png";
		}
		
		function setCarColor(c) {
			player.color = c;
			reloadCarColor();
		}
		
		document.addEventListener("keydown", (e) => {
			if (e.keyCode == 37) {
				player.keys.left = true;
			}
			if (e.keyCode == 39) {
				player.keys.right = true;
			}
		});
		
		document.addEventListener("keyup", (e) => {
			switch (e.keyCode) {
				case 37:
					player.keys.left = false;
				case 39:
					player.keys.right = false;
			}
		});
		
		let roadImg = new Image();
		roadImg.src = "res/road.png";
		let road1 = {
			x: 120,
			y: 0,
			w: 480,
			h: 480
		};
		let road2 = {
			x: 120,
			y: -480,
			w: 480,
			h: 480
		};
		
		let coinImg = new Image();
		coinImg.src = "res/coin.png";
		let coinSize = {w: 32, h: 32};
		let coins = [
			{x: randint(120, width - 120 - coinSize.h), y: -32}
		];
		
		let grassImg = new Image();
		grassImg.src = "res/grass-panel.png";
		let grassSize = {w: 120, h: 480};
		let grass1 = [
			{x: 0, y: 0, w: 120, h: 480},
			{x: 600, y: 0, w: 120, h: 480}
		];
		let grass2 = [
			{x: 0, y: -480, w: 120, h: 480},
			{x: 600, y: -480, w: 120, h: 480}
		];
		
		let treeImg = [new Image(), new Image()];
		treeImg[0].src = "res/tree1.png";
		treeImg[1].src = "res/tree2.png";
		let treeSize = {w: 32, h: 32};
		let trees = [{x: 10, y: 10, img: 1}];
		
		function checkPlayerCoin(c, i) {
			if (c.x >= player.x && c.x <= player.x + player.w && c.y >= player.y && c.y <= player.y + player.h) {
				coins.pop(i);
				player.score += 1;
				return true;
			}
			return false;
		}
		
		load();
		reloadCarColor();
		
		function draw() {
			for (let grass of grass1) {
				ctx.drawImage(grass.x, grass.y, grassSize.w, grassSize.h, grassImg);
			}
			for (let grass of grass2) {
				ctx.drawImage(grass.x, grass.y, grassSize.w, grassSize.h, grassImg);
			}
			for (let tree of trees) {
				ctx.drawImage(tree.x, tree.y, treeSize.w, treeSize.h, treeImg[tree.img]);
			}
			ctx.drawImage(5, 5, coinSize.w, coinSize.h, coinImg);
			ctx.drawText(40, 30, 25, player.score.toString());
			ctx.drawImage(road1.x, road1.y, road1.w, road1.h, roadImg);
			ctx.drawImage(road2.x, road2.y, road2.w, road2.h, roadImg);
			for (let coin of coins) {
				ctx.drawImage(coin.x, coin.y, coinSize.w, coinSize.h, coinImg);
			}
			ctx.drawImage(player.x, player.y, player.w, player.h, playerImg);
			ctx.reload();
		}
		
		function update() {
			if (player.x < width - 120 - player.w && player.keys.right) {
				player.x += player.speed.side;
			}
			if (player.x > 120 && player.keys.left) {
				player.x -= player.speed.side;
			}
			let newCoin = false;
			for (let i = 0; i < coins.length; i++) {
				coins[i].y += player.speed.forward;
				if (checkPlayerCoin(coins[i], i)) {
					i -= 1;
					newCoin = true;
				}
				if (!newCoin) {
					if (coins[i].y >= 480) {
						coins.pop(i);
						i -= 1;
						newCoin = true;
					}
				}
			}
			if (newCoin) {
				coins.push({x: randint(120, width - 120 - coinSize.h), y: -32});
			}
			road1.y += player.speed.forward;
			road2.y += player.speed.forward;
			if (road1.y >= 480) {
				road1.y = -480;
			}
			if (road2.y >= 480) {
				road2.y = -480;
			}
			grass1[0].y += player.speed.forward;
			grass1[1].y += player.speed.forward;
			grass2[0].y += player.speed.forward;
			grass2[1].y += player.speed.forward;
			if (grass1[0].y >= 480) {
				grass1[0].y = -480;
				grass1[1].y = -480;
			}
			if (grass2[0].y >= 480) {
				grass2[0].y = -480;
				grass2[1].y = -480;
			}
			let newTree = 0;
			for (let i = 0; i < trees.length; i++) {
				trees[i].y += player.speed.forward;
				if (trees[i].y >= 480) {
					newTree++;
					trees.pop(i);
					i--;
				}
			}
			for (let i = 0; i < newTree; i++) {
				if (randint(0, 1) == 0) {
					trees.push({x: randint(0, 120 - treeSize.w), y: -treeSize.h, img: randint(0, 1)});
				} else {
					trees.push({x: randint(600, width - treeSize.w), y: -treeSize.h, img: randint(0, 1)});
				}
			}
			draw();
			save();
		}
		setInterval(update, 8);
		</script>
	</body>
</html>

